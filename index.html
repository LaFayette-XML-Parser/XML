<!DOCTYPE html>
<html lang="en-US">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>XML Parser</title>
    <link class="icon" rel="icon" type="image/x-icon" href="https://github.com/LaFayette-XML-Parser/XML/blob/main/Favicon.LEI.png?raw=true">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="banner">
        <img src="https://github.com/LaFayette-XML-Parser/XML/blob/main/LEI%20Logo.png?raw=true" alt="LEI Logo">
        <p><b>Take your Hytrol XML Files and Convert them to Excel Sheets.</b></p>
    </div>    
    <div class="inside">
        <div class="titles">
            <h1>XML Parser</h1>
        </div> <br> <br>
        <button type="button" class="collapsible"> Directions â–¼ </button>
        <div class="content">
            <p>
                1. In AutoCad 2021, launch Hytrol and create your conveyor. <br> 
                2. In the Hytrol menu click file, then export project(.XML)<br> 
                3. Once done loading, name your file and save. <br> 
                4. Go to this website and press choose file.<br> 
                5. Choose your .xml file. <br> 
                6. Press the process button. <br> 
                7. It should download automatically, but if it does not, click the download link. <br> 
                8. Click on your download to pull up the CSV.
            </p>
        </div> <br>
        <div class="buttons">
            <input type="file" id="xmlFileInput" accept=".xml" class="button"> <br> <br>
            <button id="processButton" class="button">Process XML</button>
        </div>
        <div class="download">
            <a id="downloadLink" style="display: none;">Download Output</a>
        </div>
    </div>
    <div class="info-banner">
        <p class="info-a">For questions and suggestions, email: <a href='mailto:afayette.xmlparser@gmail.com'>LaFayette.XmlParser@Gmail.Com</a></p>
        <p class="info-b">LaFayette Phone Number: <a href="tel:(859) 236-6884">(859) 236-6884</a></p>
    </div>
    <script>
        var coll = document.getElementsByClassName("collapsible");
        var i;
        for (i = 0; i < coll.length; i++) {
            coll[i].addEventListener("click", 
                function() {
                    this.classList.toggle("active");
                    var content = this.nextElementSibling;
                    if (content.style.maxHeight){
                        content.style.maxHeight = null;
                    } else {
                        content.style.maxHeight = content.scrollHeight + "px";
                    } 
                }
            );
        }
        // Function to format inches to feet and inches
        function formatInchesToFeetAndInches(inches) {
            const feet = Math.floor(inches / 12);
            let remainingInches = inches % 12;
            remainingInches = parseFloat(remainingInches.toFixed(2)); // Formats inches to two points after decimal.
            if (remainingInches >= 12) {
                feet += 1;
                remainingInches -= 12;
            }
            return `${feet} ft ${remainingInches} in`;
        } // Takes any remainder greater than 12 and makes it a new foot.

        // Event listener for the process button
        document.getElementById('processButton').addEventListener('click', async () => {
            const fileInput = document.getElementById('xmlFileInput'); // Looks for the file and any previous download links.
            const downloadLink = document.getElementById('downloadLink');
            // Checks to ensure a file is submitted.
            if (fileInput.files.length === 0) {
                alert('Please select an XML file.');
                return;
            }
            // Set file data for parsing.
            const xmlFile = fileInput.files[0];
            const xmlData = await xmlFile.text();
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(xmlData, 'text/xml');

            // Initialize variables for property values
            let markedAttribute = '';
            let iopCountValue = '0';
            let modelValue = '0';
            let widthValue = '0';
            let railValue = '0';
            let curveValue = '0';
            let lengthValue = '0';
            let infeedValue = '0';
            let dischargeValue = '0';
            let hpValue = '0';
            let speedValue = '0';
            let weightValue = '0';
            let priceValue = '0';
            let psAmpValues = new Set();
            const quantityByCombination = {};
            const propertiesElements = xmlDoc.querySelectorAll('Properties');

            // Iterate through 'Properties' elements
            propertiesElements.forEach(propertiesElement => {
                psAmpValues = new Set(); // Creates a set of values for amps.
                const refNameElements = propertiesElement.querySelectorAll('RefName');

                // Reset variables for each new Properties element
                curveValue = '0';
                infeedValue = '0';
                dischargeValue = '0';
                hpValue = '0';
                iopCountValue = '0';
                speedValue = '0';

                refNameElements.forEach(refNameElement => { // Parses through each ref name.
                    const propertyName = refNameElement.textContent;
                    const valueElement = refNameElement.nextElementSibling;

                    // Assign values based on property name
                    if (propertyName === 'MarkNumber') {
                        markedAttribute = valueElement.textContent;
                    } else if (propertyName === 'Model') {
                        modelValue = valueElement.textContent;
                    } else if (propertyName === 'iopcount') {
                        iopCountValue = valueElement.textContent;
                    } else if (propertyName === 'overallwidth') {
                        widthValue = formatInchesToFeetAndInches(parseFloat(valueElement.textContent)); // Formats to inches when called.
                    } else if (propertyName === 'rollercenters') {
                        railValue = formatInchesToFeetAndInches(parseFloat(valueElement.textContent));
                    } else if (propertyName === 'curveangle') {
                        curveValue = valueElement.textContent;
                    } else if (propertyName === 'overalllength') {
                        lengthValue = formatInchesToFeetAndInches(parseFloat(valueElement.textContent));
                    } else if (propertyName === 'infeedheight') {
                        infeedValue = formatInchesToFeetAndInches(parseFloat(valueElement.textContent));
                    } else if (propertyName === 'dischargeheight') {
                        dischargeValue = formatInchesToFeetAndInches(parseFloat(valueElement.textContent));
                    } else if (propertyName === 'hp') {
                        hpValue = valueElement.textContent;
                    } else if (propertyName === 'fpm') {
                        speedValue = valueElement.textContent;
                    } else if (propertyName === 'conveyorweight') {
                        weightValue = valueElement.textContent;
                    } else if (propertyName === 'powersupplysize') { // PS Amp.
                        const psAmpValue = valueElement.textContent;
                        if (psAmpValue.trim() === '') { // If there is nothing, a zero is added.
                            psAmpValues.add('0');
                        } else if (psAmpValue.toLowerCase() !== 'less power supply') { // The case for the ref of LPS turned into a value.
                            const ampMatch = psAmpValue.match(/\d+/);
                            if (ampMatch) {
                                psAmpValues.add(ampMatch[0]);
                            }
                        }
                    } else if (propertyName === 'TotalPrice') {
                        priceValue = `$${parseFloat(valueElement.textContent || '0').toFixed(2)}`; // Make to two decimals out.
                    }
                });

                // Generate a unique key for this combination of properties to check for repeated lines.
                const combinationKey = `${markedAttribute}_${modelValue}_${priceValue}`;

                // Store or update the combination's properties and quantities for each new line.
                if (!quantityByCombination[combinationKey]) {
                    quantityByCombination[combinationKey] = {
                        quantity: 0,
                        psAmpValues: new Set(),
                        price: priceValue,
                        modelValue: modelValue,
                        markedAttribute: markedAttribute,
                        iopCountValue: iopCountValue,
                        widthValue: widthValue,
                        railValue: railValue,
                        curveValue: curveValue,
                        lengthValue: lengthValue,
                        infeedValue: infeedValue,
                        dischargeValue: dischargeValue,
                        hpValue: hpValue,
                        speedValue: speedValue,
                        weightValue: weightValue
                    };
                }

                // Add the current amps to the combination's set of amps
                psAmpValues.forEach(psAmp => {
                    quantityByCombination[combinationKey].psAmpValues.add(psAmp);
                });
            });

            // Prepare CSV data
            let csvData = '';
            let totalPrice = 0;
            let isFirstRow = true;

            // Add Column titles to CSV data with Excel styles
            const headersRow = '<div class="excel-header">Unit Mark</div>,<div class="excel-header">Model</div>,<div class="excel-header">Width</div>,<div class="excel-header">Rlr Ctrs</div>,<div class="excel-header">Curve</div>,<div class="excel-header">Length</div>,<div class="excel-header">Inf El</div>,<div class="excel-header">Dis El</div>,<div class="excel-header">HP</div>,<div class="excel-header">PS Qty</div>,<div class="excel-header">PS Amp</div>,<div class="excel-header">IOP Qty</div>,<div class="excel-header">Speed</div>,<div class="excel-header">Weight</div>,<div class="excel-header">List Price</div>,<div class="excel-header">Cost</div>\n';
            csvData = headersRow + csvData;

            // Loop through each combination
            for (const combinationKey in quantityByCombination) {
                if (quantityByCombination.hasOwnProperty(combinationKey)) {
                    const combination = quantityByCombination[combinationKey];
                    let ampsRow = Array.from(combination.psAmpValues).join('|');
                    const quantityRow = combination.psAmpValues.size;
        
                    if (ampsRow === '') {
                        ampsRow = '0';
                    }
        
                    // Apply Excel cell styles to each cell in the row
                    const csvRow = `<div class="excel-cell">${combination.markedAttribute}</div>,<div class="excel-cell">${combination.modelValue}</div>,<div class="excel-cell">${combination.widthValue}</div>,<div class="excel-cell">${combination.railValue}</div>,<div class="excel-cell">${combination.curveValue}</div>,<div class="excel-cell">${combination.lengthValue}</div>,<div class="excel-cell">${combination.infeedValue}</div>,<div class="excel-cell">${combination.dischargeValue}</div>,<div class="excel-cell">${combination.hpValue}</div>,<div class="excel-cell">${quantityRow}</div>,<div class="excel-cell">${ampsRow}</div>,<div class="excel-cell">${combination.iopCountValue}</div>,<div class="excel-cell">${combination.speedValue}</div>,<div class="excel-cell">${combination.weightValue}</div>,<div class="excel-cell">${combination.price}</div>,<div class="excel-cell"></div>\n`;
        
                    csvData += csvRow;
                    totalPrice += parseFloat(combination.price.replace('$', ''));
                }
            }
            // Add total price row to CSV data
            const totalRow = ` , , , , , , , , , , , , ,  Total Prices, $${totalPrice.toFixed(2)}, $`;
            csvData += totalRow + '\n';

            // Create a Blob containing the CSV data
            const blob = new Blob([csvData], {
                type: 'text/csv'
            });

            const xmlFileName = xmlFile.name.replace(/\s+/g, '_').replace('.xml', ''); // Create a unique file name correlated to the parsed file's name.
            downloadLink.href = URL.createObjectURL(blob); // Create a download link for file.
            downloadLink.download = `${xmlFileName}.csv`;

            // Trigger the download
            if (totalPrice > 0) { // Starts as long as there is something there.
                downloadLink.style.display = 'block';
                downloadLink.click();
                URL.revokeObjectURL(downloadLink.href);
            } else {
                alert('No data to download.');
                downloadLink.style.display = 'none';
            }
        });
    </script>
</body>
</html>
