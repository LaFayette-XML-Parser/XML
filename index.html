<!DOCTYPE html>
<html>

<head>
    <title>XML Parser</title>
    <link rel="icon" type="image/x-icon"
        href="https://github.com/LaFayette-XML-Parser/XML/blob/main/Favicon.LEI.png?raw=true">
    <style>
        .flex-parent-element {
            display: flex;
            width: 125%;
        }

        .flex-child-element {
            font-family: "Times New Roman", Times, serif;
            flex: 1;
            margin: 0px;
        }

        .flex-child-element:first-child {
            margin-right: 20px;
        }

        .inside {
            font-family: "Times New Roman", Times, serif;
            background-color: #f3f6f4;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 70vh;
            width: 100vh;
            margin: 0 auto;
            text-align-last: center;
            line-height: 1.4;
        }

        .outside {
            font-family: "Times New Roman", Times, serif;
            background-color: #f3f6f4;
            display: flex;
            align-items: flex-start;
            justify-content: center;
            height: 2vh;
            margin: 0 auto;
            text-align-last: center;
            line-height: 1.4;
        }
    </style>
</head>

<body style="background-color: #f3f6f4">

    <div class="flex-parent-element" style="background-color: white">
        <div class="flex-child-element"><img
                src="https://github.com/LaFayette-XML-Parser/XML/blob/main/LEI%20Logo.png?raw=true"></div>
        <div class="flex-child-element">
            <p><b> Take your Hytrol XML Files and Convert them to Excel Sheets </b></p>
        </div>
    </div>
    <div class="outside">
        <h1>XML Parser<br><br></h1>
    </div>
    <div class="inside">
        <div>
            <p style="font-size:8pt"><b style="font-size:12pt">Directions:</b><br>
                1. In AutoCad 2021, launch Hytrol and create your conveyor. <br>
                2. In the Hytrol menu click file, then Export Project (.XML)<br>
                3. Once done loading, name your file and save. <br>
                4. Go to this website and press choose file.<br>
                5. Choose your .xml file. <br>
                6. Press the process button. <br>
                7. It should download automatically, but if it does not, click the download link. <br>
                8. Click on your download to pull up the CSV.
            </p>
        </div>
        <br>
        <!-- Input file element -->
        <input type="file" id="xmlFileInput" accept=".xml">
        <!-- Process button -->
        <button id="processButton">Process XML</button>
        <!-- Download link -->
        <div>
            <a id="downloadLink" style="display: none;">Download Output</a>
        </div>
    </div>
    <script>
        // Function to format inches to feet and inches
        function formatInchesToFeetAndInches(inches) {
            const feet = Math.floor(inches / 12);
            let remainingInches = inches % 12;
            remainingInches = parseFloat(remainingInches.toFixed(2));
            if (remainingInches >= 12) {
                feet += 1;
                remainingInches -= 12;
            }
            return `${feet} ft ${remainingInches} in`;
        }

        // Event listener for the process button
        document.getElementById('processButton').addEventListener('click', async () => {
            const fileInput = document.getElementById('xmlFileInput');
            const downloadLink = document.getElementById('downloadLink');

            if (fileInput.files.length === 0) {
                alert('Please select an XML file.');
                return;
            }

            const xmlFile = fileInput.files[0];
            const xmlData = await xmlFile.text();

            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(xmlData, 'text/xml');

            // Initialize variables for property values
            let markedAttribute = '';
            let iopCountValue = '';
            let modelValue = '';
            let widthValue = '';
            let railValue = '';
            let curveValue = '';
            let lengthValue = '';
            let infeedValue = '';
            let dischargeValue = '';
            let hpValue = '';
            let speedValue = '';
            let weightValue = '';
            let priceValue = '';
            let psAmpValues = new Set();
            const quantityByCombination = {};
            const propertiesElements = xmlDoc.querySelectorAll('Properties');

            // Iterate through 'Properties' elements
            propertiesElements.forEach(propertiesElement => {
                psAmpValues = new Set();

                const refNameElements = propertiesElement.querySelectorAll('RefName');

                refNameElements.forEach(refNameElement => {
                    const propertyName = refNameElement.textContent;
                    const valueElement = refNameElement.nextElementSibling;

                    // Assign values based on property name
                    if (propertyName === 'MarkNumber') {
                        markedAttribute = valueElement.textContent;
                    } else if (propertyName === 'Model') {
                        modelValue = valueElement.textContent;
                    } else if (propertyName === 'iopcount') {
                        iopCountValue = valueElement.textContent;
                    } else if (propertyName === 'overallwidth') {
                        widthValue = formatInchesToFeetAndInches(parseFloat(valueElement.textContent));
                    } else if (propertyName === 'rollercenters') {
                        railValue = formatInchesToFeetAndInches(parseFloat(valueElement.textContent));
                    } else if (propertyName === 'curveangle') {
                        curveValue = valueElement.textContent;
                    } else if (propertyName === 'overalllength') {
                        lengthValue = formatInchesToFeetAndInches(parseFloat(valueElement.textContent));
                    } else if (propertyName === 'infeedheight') {
                        infeedValue = formatInchesToFeetAndInches(parseFloat(valueElement.textContent));
                    } else if (propertyName === 'dischargeheight') {
                        dischargeValue = formatInchesToFeetAndInches(parseFloat(valueElement.textContent));
                    } else if (propertyName === 'hp') {
                        hpValue = valueElement.textContent;
                    } else if (propertyName === 'fpm') {
                        speedValue = valueElement.textContent;
                    } else if (propertyName === 'conveyorweight') {
                        weightValue = valueElement.textContent;
                    } else if (propertyName === 'powersupplysize') {
                        const psAmpValue = valueElement.textContent;
                        if (psAmpValue.trim() === '') {
                            psAmpValues.add('');
                        } else if (psAmpValue.toLowerCase() !== 'less power supply') {
                            const ampMatch = psAmpValue.match(/\d+/);
                            if (ampMatch) {
                                psAmpValues.add(ampMatch[0]);
                            }
                        }
                    } else if (propertyName === 'TotalPrice') {
                        priceValue = `$${parseFloat(valueElement.textContent || '0').toFixed(2)}`;
                    }
                });

                // Generate a unique key for this combination of properties
                const combinationKey = `${markedAttribute}_${modelValue}_${priceValue}`;

                // Store or update the combination's properties and quantities
                if (!quantityByCombination[combinationKey]) {
                    quantityByCombination[combinationKey] = {
                        quantity: 0,
                        psAmpValues: new Set(),
                        price: priceValue,
                        modelValue: modelValue,
                        markedAttribute: markedAttribute,
                        iopCountValue: iopCountValue,
                        widthValue: widthValue,
                        railValue: railValue,
                        curveValue: curveValue,
                        lengthValue: lengthValue,
                        infeedValue: infeedValue,
                        dischargeValue: dischargeValue,
                        hpValue: hpValue,
                        speedValue: speedValue,
                        weightValue: weightValue
                    };
                }
                // Add the current amps to the combination's set of amps
                psAmpValues.forEach(psAmp => {
                    quantityByCombination[combinationKey].psAmpValues.add(psAmp);
                });
            });

            // Prepare CSV data
            let csvData = '';
            let totalPrice = 0;
            let isFirstRow = true;

            // Add headers to CSV data
            const headersRow = 'Mark #, Model, IOP, Width, Rail, Curve, Length, Infeed, Discharge, HP, Speed, Weight, Quantity, Amps, Price\n';
            csvData = headersRow + csvData;

            // Loop through each combination
            for (const combinationKey in quantityByCombination) {
                if (quantityByCombination.hasOwnProperty(combinationKey)) {
                    const combination = quantityByCombination[combinationKey];
                    const ampsRow = Array.from(combination.psAmpValues).join('|');
                    const quantityRow = combination.psAmpValues.size;
                    const csvRow = `${combination.markedAttribute},${combination.modelValue},${combination.iopCountValue},${combination.widthValue},${combination.railValue},${combination.curveValue},${combination.lengthValue},${combination.infeedValue},${combination.dischargeValue},${combination.hpValue},${combination.speedValue},${combination.weightValue},${quantityRow},${ampsRow},${combination.price}\n`;

                    // Skip the first row
                    if (isFirstRow) {
                        isFirstRow = false;
                        continue;
                    }

                    csvData += csvRow;

                    // Accumulate price for total price
                    totalPrice += parseFloat(combination.price.replace('$', ''));
                }
            }

            // Add total row to CSV data
            const totalRow = ` , , , , , , , , , , , , ,  Total Price, $${totalPrice.toFixed(2)}`;
            csvData += totalRow + '\n';

            // Create a Blob containing the CSV data
            const blob = new Blob([csvData], {
                type: 'text/csv'
            });
            const xmlFileName = xmlFile.name.replace(/\s+/g, '_').replace('.xml', '');
            downloadLink.href = URL.createObjectURL(blob);
            downloadLink.download = `${xmlFileName}.csv`;

            // Trigger the download
            if (totalPrice > 0) {
                downloadLink.style.display = 'block';
                downloadLink.click();
                URL.revokeObjectURL(downloadLink.href);
            } else {
                alert('No data to download.');
                downloadLink.style.display = 'none';
            }
        });
    </script>
</body>

</html>
